name: Publish Extension

on:
    push:
        branches: [main]
    workflow_dispatch: # Allow manual triggering if needed

permissions:
    contents: read
    id-token: write

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch full history for commit hash

            - name: Free disk space
              if: runner.os == 'Linux'
              uses: ./.github/actions/free-disk-space

            - name: Install Nix
              uses: DeterminateSystems/nix-installer-action@main

            - name: Magic Nix Cache
              uses: DeterminateSystems/magic-nix-cache-action@main

            - name: Calculate unique version
              id: version
              run: |
                  cd vscode-extension
                  MAJOR_VERSION=$(jq -r '.version | split(".")[0]' package.json)
                  # Generate minor version as YYYYMMDDHH
                  MINOR_VERSION=$(date -u +"%Y%m%d%H")
                  PATCH_VERSION="0"
                  UNIQUE_VERSION="${MAJOR_VERSION}.${MINOR_VERSION}.${PATCH_VERSION}"
                  echo "VERSION=${UNIQUE_VERSION}" >> $GITHUB_OUTPUT
                  echo "Unique version: ${UNIQUE_VERSION}"

            - name: Build VSCode extension with Nix
              run: nix build .#vscode-extension

            - name: Update version in built extension
              run: |
                  mkdir -p publish
                  VSIX_FILE=$(ls result/*.vsix)
                  UNIQUE_VERSION="${{ steps.version.outputs.VERSION }}"

                  # Extract the vsix (it's a zip file)
                  TEMP_DIR=$(mktemp -d)
                  unzip -q "$VSIX_FILE" -d "$TEMP_DIR"

                  # Update version in extension/package.json inside the vsix
                  jq --arg version "$UNIQUE_VERSION" '.version = $version' "$TEMP_DIR/extension/package.json" > "$TEMP_DIR/extension/package.json.tmp"
                  mv "$TEMP_DIR/extension/package.json.tmp" "$TEMP_DIR/extension/package.json"

                  # Repackage the vsix
                  OUTPUT_VSIX="publish/parquet-querier-${UNIQUE_VERSION}.vsix"
                  (cd "$TEMP_DIR" && zip -qr - .) > "$OUTPUT_VSIX"

                  rm -rf "$TEMP_DIR"
                  echo "Created $OUTPUT_VSIX with version $UNIQUE_VERSION"
                  ls -lh publish/

            - name: Publish to VS Code Marketplace
              run: |
                  nix develop --command bash -c "vsce publish -p ${{ secrets.VSCE_TOKEN }} --packagePath publish/*.vsix"
              env:
                  VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}

            - name: Publish to Open VSX Registry
              run: |
                  nix develop --command bash -c "npx ovsx publish publish/*.vsix -p ${{ secrets.OVSX_TOKEN }}"
              env:
                  OVSX_TOKEN: ${{ secrets.OVSX_TOKEN }}

            - name: Summary
              run: |
                  echo "### Extension Published :rocket:" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version**: ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Extension has been published to both VS Code Marketplace and Open VSX Registry." >> $GITHUB_STEP_SUMMARY
