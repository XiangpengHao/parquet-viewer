name: Publish Extension

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering if needed

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for commit hash

      - name: Free disk space
        if: runner.os == 'Linux'
        uses: ./.github/actions/free-disk-space
      
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
      
      - name: Calculate unique version
        id: version
        run: |
          cd vscode-extension
          BASE_VERSION=$(jq -r '.version' package.json)
          COMMIT_HASH=$(git rev-parse --short=7 HEAD)
          UNIQUE_VERSION="${BASE_VERSION}+${COMMIT_HASH}"
          echo "VERSION=${UNIQUE_VERSION}" >> $GITHUB_OUTPUT
          echo "BASE_VERSION=${BASE_VERSION}" >> $GITHUB_OUTPUT
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "Unique version: ${UNIQUE_VERSION}"
      
      - name: Update package.json with unique version
        run: |
          cd vscode-extension
          # Create temporary version with commit hash
          jq --arg version "${{ steps.version.outputs.VERSION }}" '.version = $version' package.json > package.json.tmp
          mv package.json.tmp package.json
          echo "Updated package.json to version ${{ steps.version.outputs.VERSION }}"
          
          # Also update package-lock.json to keep them in sync
          jq --arg version "${{ steps.version.outputs.VERSION }}" '.version = $version' package-lock.json > package-lock.json.tmp
          mv package-lock.json.tmp package-lock.json
      
      - name: Build VSCode extension with Nix
        run: nix build .#vscode-extension
      
      - name: Extract built extension
        run: |
          mkdir -p publish
          cp result/*.vsix publish/
          ls -lh publish/
      
      - name: Publish to VS Code Marketplace
        run: |
          nix develop --command bash -c "vsce publish -p ${{ secrets.VSCE_TOKEN }} --packagePath publish/*.vsix"
        env:
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
      
      - name: Publish to Open VSX Registry
        run: |
          nix develop --command bash -c "npx ovsx publish publish/*.vsix -p ${{ secrets.OVSX_TOKEN }}"
        env:
          OVSX_TOKEN: ${{ secrets.OVSX_TOKEN }}
      
      - name: Summary
        run: |
          echo "### Extension Published :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Version**: ${{ steps.version.outputs.BASE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ steps.version.outputs.COMMIT_HASH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Extension has been published to both VS Code Marketplace and Open VSX Registry." >> $GITHUB_STEP_SUMMARY
